# 完整应用栈配置 (前端 + 后端 + 依赖服务)
# 使用方式: docker-compose up -d
# 访问地址:
#   - 前端: http://localhost:3000
#   - 后端 API: http://localhost:8080
#   - Swagger 文档: http://localhost:8080/swagger-ui.html

services:
  mysql:
    image: mysql:8.0
    container_name: oilgas-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root123456
      MYSQL_DATABASE: oilgas_test
      MYSQL_USER: yimusi
      MYSQL_PASSWORD: yimusi123456
    volumes:
      - ./data/mysql:/var/lib/mysql
    command:
      - --default-authentication-plugin=mysql_native_password
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION

  redis:
    image: redis:7-alpine
    container_name: oilgas-redis
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes --requirepass redis123456

  backend:
    image: registry.cn-hangzhou.aliyuncs.com/xusheng/oilgas-test-platform-be:dev-936b59b
    container_name: oilgas-backend
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: prod
      # 数据库配置（覆盖 application-prod.yml）
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/oilgas_test?useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: yimusi
      SPRING_DATASOURCE_PASSWORD: yimusi123456
      # Redis 配置（覆盖 application-prod.yml）
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: redis123456
      # JWT 密钥（覆盖 application-prod.yml）
      SA_TOKEN_JWT_SECRET_KEY: "your-jwt-secret-key-for-docker-production"
      # JPA DDL 自动建表策略（开发环境可设置为 update，生产环境建议为 none）
      JPA_DDL_AUTO: update
      # 日志路径
      LOG_PATH: /app/logs
      # 修复 JAVA_OPTS 问题 - 设置为空字符串
      JAVA_OPTS: ""
    volumes:
      - ./logs:/app/logs
    depends_on:
      - mysql
      - redis
    restart: unless-stopped
    # 显式覆盖启动命令，避免镜像内部的 JAVA_OPTS 问题
    command: ["java", "-jar", "/app/app.jar"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  frontend:
    image: registry.cn-hangzhou.aliyuncs.com/xusheng/oilgas-test-platform-fe:dev-e795d07
    container_name: oilgas-frontend
    restart: unless-stopped
    ports:
      - '3000:8080'
    environment:
      - API_URL=http://backend:8080
    depends_on:
      - backend
